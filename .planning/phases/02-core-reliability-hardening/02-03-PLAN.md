---
phase: 02-core-reliability-hardening
plan: 03
type: execute
wave: 3
depends_on: [01, 02]
files_modified:
  - BOF_spawn.cna
  - Src/Bof.c
autonomous: true
requirements: [RELI-03]
must_haves:
  truths:
    - Invalid execution-method preconditions are rejected before thread-context modification.
    - Callback mode remains hard-gated on CFG-disable with actionable next-step errors.
    - Operator diagnostics for invalid combinations remain concise and fix-oriented.
  artifacts:
    - BOF_spawn.cna
    - Src/Bof.c
  key_links:
    - BOF_spawn.cna preflight checks align with Src/Bof.c defensive precondition validation.
---

<objective>
Add explicit execution precondition gating before context tampering operations.

Purpose: satisfy RELI-03 with fail-early validation and clear diagnostics.
Output: deterministic precondition checks in operator preflight and BOF runtime guard path.
</objective>

<execution_context>
@/Users/maleick/.codex/get-shit-done/workflows/execute-plan.md
@/Users/maleick/.codex/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/REQUIREMENTS.md
@.planning/STATE.md
@.planning/phases/02-core-reliability-hardening/02-CONTEXT.md
@.planning/phases/02-core-reliability-hardening/02-RESEARCH.md
@BOF_spawn.cna
@Src/Bof.c
</context>

<tasks>

<task type="auto">
  <name>Task 1: Centralize execution precondition validation in BOF runtime</name>
  <files>Src/Bof.c</files>
  <action>Introduce a dedicated precondition helper for execution mode checks and invoke it before any `NtGetContextThread`/`NtSetContextThread` path. Keep callback+CFG mismatch and unsupported method handling fail-early with one-line remediation text.</action>
  <verify><automated>rg -n 'invalid execution method|callback blocked|NtGetContextThread|NtSetContextThread|precondition' Src/Bof.c</automated></verify>
  <done>No invalid execution combination reaches thread-context modification branches.</done>
</task>

<task type="auto">
  <name>Task 2: Align CNA preflight diagnostics with runtime precondition contract</name>
  <files>BOF_spawn.cna</files>
  <action>Ensure operator-side preflight for execution method and callback/CFG combinations mirrors runtime guard semantics and preserves concise "cause + next step" output style without verbose default-mode dumps.</action>
  <verify><automated>rg -n 'preflight_validate_execution|unknown execution method|callback blocked|next step' BOF_spawn.cna</automated></verify>
  <done>CNA and BOF enforce the same RELI-03 validation contract and messaging style.</done>
</task>

<task type="auto">
  <name>Task 3: Add contract comments for precondition timing guarantees</name>
  <files>Src/Bof.c, BOF_spawn.cna</files>
  <action>Add concise comments documenting that preconditions are validated before thread-context modifications and that runtime checks remain defensive fail-closed backstops.</action>
  <verify><automated>rg -n 'before thread-context modification|fail-closed backstop|precondition' Src/Bof.c BOF_spawn.cna</automated></verify>
  <done>Precondition timing guarantees are explicit and maintainable in both operator and runtime surfaces.</done>
</task>

</tasks>

<verification>
- RELI-03 is represented in frontmatter and covered by task outcomes.
- Invalid execution combinations are blocked before context mutation.
- Diagnostic style remains concise/action-first with clear remediation.
</verification>

<success_criteria>
- [ ] RELI-03 implemented completely.
- [ ] Precondition failures happen before thread-context mutation.
- [ ] Operator/runtime diagnostics remain actionable and low-noise.
</success_criteria>

<output>
After completion, create .planning/phases/02-core-reliability-hardening/02-03-SUMMARY.md.
</output>
