---
phase: 01-safety-defaults-contract-guardrails
plan: 02
type: execute
wave: 2
depends_on: [01]
files_modified:
  - BOF_spawn.cna
  - Src/Bof.c
autonomous: true
requirements: [SAFE-02]
must_haves:
  truths:
    - Callback execution is hard-blocked when CFG-disable is off.
    - Warnings are shown before execution only.
    - Failure output is one-line cause plus next step, with deeper diagnostics only in explicit debug mode.
  artifacts:
    - BOF_spawn.cna
    - Src/Bof.c
  key_links:
    - BOF_spawn.cna preflight validation blocks callback/CFG mismatch prior to bof_pack.
    - Src/Bof.c runtime check preserves same callback/CFG invariant as fail-closed defense.
---

<objective>
Add explicit callback/CFG guardrails and enforce operator feedback contract.

Purpose: prevent invalid execution combinations while keeping default output low-noise.
Output: shared CNA gate plus BOF defensive check with remediation-oriented messaging.
</objective>

<execution_context>
@/Users/maleick/.codex/get-shit-done/workflows/execute-plan.md
@/Users/maleick/.codex/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/REQUIREMENTS.md
@.planning/STATE.md
@.planning/phases/01-safety-defaults-contract-guardrails/01-CONTEXT.md
@.planning/phases/01-safety-defaults-contract-guardrails/01-RESEARCH.md
@BOF_spawn.cna
@Src/Bof.c
</context>

<tasks>

<task type="auto">
  <name>Task 1: Implement shared callback/CFG preflight hard gate in CNA</name>
  <files>BOF_spawn.cna</files>
  <action>Create a reusable preflight helper invoked by both aliases. If callback mode is selected and CFG-disable is false, block execution immediately with clear remediation text.</action>
  <verify><automated>rg -n 'callback.*blocked|enable CFG-disable|preflight|spawn_beacon|spawn_shellcode' BOF_spawn.cna</automated></verify>
  <done>Invalid callback+CFG combinations never reach BOF execution dispatch in either alias path.</done>
</task>

<task type="auto">
  <name>Task 2: Add explicit debug escalation and concise default failures</name>
  <files>BOF_spawn.cna</files>
  <action>Introduce explicit on-demand debug toggle handling. Keep default warnings pre-execution only and ensure failure text stays one-line cause plus next step.</action>
  <verify><automated>rg -n 'debug|warning|next step|callback' BOF_spawn.cna</automated></verify>
  <done>Default operator output remains concise while deeper diagnostics require explicit debug mode.</done>
</task>

<task type="auto">
  <name>Task 3: Mirror callback precondition in BOF runtime path</name>
  <files>Src/Bof.c</files>
  <action>Add early runtime guard so callback execution path fails closed when CFG-disable is off, with remediation-focused error text matching CNA semantics.</action>
  <verify><automated>rg -n 'HIJACK_RIP_CALLBACK|DisableCfg|CFG|BeaconPrintf\(CALLBACK_ERROR' Src/Bof.c</automated></verify>
  <done>BOF runtime does not proceed with callback execution under invalid CFG state.</done>
</task>

</tasks>

<verification>
- SAFE-02 is fully mapped by requirements and tasks.
- CNA hard-block exists for callback/CFG mismatch.
- BOF runtime contains defensive invariant check.
</verification>

<success_criteria>
- [ ] SAFE-02 implemented completely.
- [ ] Callback+CFG mismatch fails closed with clear remediation.
- [ ] Feedback style contract remains action-first/concise.
</success_criteria>

<output>
After completion, create .planning/phases/01-safety-defaults-contract-guardrails/01-02-SUMMARY.md.
</output>
