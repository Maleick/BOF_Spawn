---
phase: 01-safety-defaults-contract-guardrails
plan: 02
type: execute
wave: 2
depends_on: [01]
files_modified:
  - BOF_spawn.cna
  - Src/Bof.c
autonomous: true
requirements: [SAFE-02]
must_haves:
  truths:
    - Callback mode cannot run when CFG-disable is off.
    - Callback risk/precondition messaging appears before execution only.
    - Failure output is one-line cause plus next step, with debug detail opt-in.
  artifacts:
    - BOF_spawn.cna
    - Src/Bof.c
  key_links:
    - BOF_spawn.cna preflight guard blocks invalid callback/CFG combinations before bof_pack.
    - Src/Bof.c enforces the same callback/CFG invariant as runtime defense.
---

<objective>
Add explicit callback/CFG guardrails and operator-focused pre-execution feedback.

Purpose: fail closed on invalid callback prerequisites while keeping default output low-noise.
Output: deterministic preflight gate + concise remediation messaging + optional debug escalation.
</objective>

<execution_context>
@/Users/maleick/.codex/get-shit-done/workflows/execute-plan.md
@/Users/maleick/.codex/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/REQUIREMENTS.md
@.planning/STATE.md
@.planning/phases/01-safety-defaults-contract-guardrails/01-CONTEXT.md
@.planning/phases/01-safety-defaults-contract-guardrails/01-RESEARCH.md
@BOF_spawn.cna
@Src/Bof.c
</context>

<tasks>

<task type="auto">
  <name>Task 1: Implement CNA callback/CFG hard gate for both aliases</name>
  <files>BOF_spawn.cna</files>
  <action>Create a shared preflight helper that validates execution-mode prerequisites before BOF load/pack. If execution method is callback and CFG-disable is off, hard-block with one-line cause and explicit remediation to enable CFG-disable then retry. Use this helper in both alias paths.</action>
  <verify><automated>rg -n 'callback.*blocked|enable CFG-disable|preflight|spawn_beacon|spawn_shellcode' BOF_spawn.cna</automated></verify>
  <done>Invalid callback/CFG combinations are rejected before execution in both alias commands.</done>
</task>

<task type="auto">
  <name>Task 2: Add concise warning and debug escalation behavior</name>
  <files>BOF_spawn.cna</files>
  <action>Add a session-level debug toggle and keep default output action-first concise. Show callback-specific risk/precondition warning only before execution; route deeper diagnostics through explicit debug mode rather than default output.</action>
  <verify><automated>rg -n 'debug|risk warning|one-line|next step|callback' BOF_spawn.cna</automated></verify>
  <done>Default run output remains low-noise; deep details appear only when debug mode is explicitly enabled.</done>
</task>

<task type="auto">
  <name>Task 3: Add BOF-side defensive callback precondition check</name>
  <files>Src/Bof.c</files>
  <action>Before callback-context hijack operations, enforce the same invariant at runtime: callback method requires CFG-disable. Return failure early with concise remediation text so bypassed CNA calls still fail closed.</action>
  <verify><automated>rg -n 'HIJACK_RIP_CALLBACK|DisableCfg|requires CFG|BeaconPrintf\(CALLBACK_ERROR' Src/Bof.c</automated></verify>
  <done>BOF runtime never attempts callback flow when CFG-disable is off.</done>
</task>

</tasks>

<verification>
- Confirm SAFE-02 is explicitly addressed by hard gate behavior.
- Confirm warnings are pre-execution only.
- Confirm both CNA and BOF enforce callback/CFG invariant.
</verification>

<success_criteria>
- [ ] SAFE-02 is fully implemented by this plan.
- [ ] Callback+CFG mismatch is hard-blocked with remediation.
- [ ] Default output style remains concise and fix-oriented.
</success_criteria>

<output>
After completion, create .planning/phases/01-safety-defaults-contract-guardrails/01-02-SUMMARY.md.
</output>
