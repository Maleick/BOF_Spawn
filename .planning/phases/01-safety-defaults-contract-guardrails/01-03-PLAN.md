---
phase: 01-safety-defaults-contract-guardrails
plan: 03
type: execute
wave: 3
depends_on: [01, 02]
files_modified:
  - BOF_spawn.cna
  - Src/Bof.c
  - README.md
autonomous: true
requirements: [SAFE-03]
must_haves:
  truths:
    - Every dialog toggle and execution method maps deterministically to BOF parser fields.
    - Unknown execution-method values fail explicitly instead of falling back silently.
    - Pack/parse contract is documented in maintainable operator/developer docs.
  artifacts:
    - BOF_spawn.cna
    - Src/Bof.c
    - README.md
  key_links:
    - BOF_spawn.cna bof_pack format/order matches Src/Bof.c go() parse order.
    - README contract table matches the code-level mapping implementation.
---

<objective>
Validate and document the CNA packing contract and enforce deterministic mapping behavior.

Purpose: eliminate hidden fallback semantics and keep CNA-to-BOF interface drift visible.
Output: shared mapping/packing path plus explicit contract documentation.
</objective>

<execution_context>
@/Users/maleick/.codex/get-shit-done/workflows/execute-plan.md
@/Users/maleick/.codex/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/REQUIREMENTS.md
@.planning/STATE.md
@.planning/phases/01-safety-defaults-contract-guardrails/01-CONTEXT.md
@.planning/phases/01-safety-defaults-contract-guardrails/01-RESEARCH.md
@BOF_spawn.cna
@Src/Bof.c
@README.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Remove duplicated exec mapping and hidden fallback behavior</name>
  <files>BOF_spawn.cna</files>
  <action>Replace duplicated per-alias execution-method mapping blocks with one shared resolver helper. Unknown values must fail with explicit operator error and no implicit `0` fallback.</action>
  <verify><automated>rg -n 'resolve.*exec|unknown execution|fallback|Hijack RIP Direct|Hijack RIP Callback' BOF_spawn.cna</automated></verify>
  <done>Execution method conversion is centralized and deterministic for all command paths.</done>
</task>

<task type="auto">
  <name>Task 2: Centralize argument packing contract usage</name>
  <files>BOF_spawn.cna</files>
  <action>Create a shared helper that assembles normalized integer flags and calls `bof_pack("ZZZZiiiib", ...)` in one place for both aliases. Keep field order fixed and commented as contract-critical.</action>
  <verify><automated>rg -n 'bof_pack\(\$1, "ZZZZiiiib"|contract-critical|spawn_beacon|spawn_shellcode' BOF_spawn.cna</automated></verify>
  <done>Both aliases use identical packing code path and argument order.</done>
</task>

<task type="auto">
  <name>Task 3: Document and cross-check pack/parse contract</name>
  <files>README.md, Src/Bof.c</files>
  <action>Add a concise mapping table documenting each CNA field, packed index/type, and BOF parser destination. Update `Src/Bof.c` comments near `go()` argument extraction to mirror the same order and enum mapping values.</action>
  <verify><automated>rg -n 'ZZZZiiiib|BeaconDataExtract|BeaconDataInt|execution method|mapping table' README.md Src/Bof.c</automated></verify>
  <done>Contract documentation and source comments match the implemented packing/parsing sequence without ambiguity.</done>
</task>

</tasks>

<verification>
- Confirm SAFE-03 is explicitly addressed by deterministic mapping + docs.
- Confirm no alias keeps a private mapping branch.
- Confirm documented contract order matches parser order exactly.
</verification>

<success_criteria>
- [ ] SAFE-03 is fully implemented by this plan.
- [ ] No hidden mapping fallback remains in CNA.
- [ ] Contract documentation and parser comments are synchronized.
</success_criteria>

<output>
After completion, create .planning/phases/01-safety-defaults-contract-guardrails/01-03-SUMMARY.md.
</output>
